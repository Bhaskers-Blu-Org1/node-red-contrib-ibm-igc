<!--
  Copyright 2017 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script type="text/x-red" data-template-name="ibm-igc">
  <div class="form-row">
    <label for="node-config-input-host"><i class="fa fa-bookmark"></i> Host</label>
    <input class="input-append-left" type="text" id="node-config-input-host" placeholder="your-server.com">
  </div>
  <div class="form-row">
    <label for="node-config-input-port"><i class="fa fa-circle-o"></i> Port</label>
    <input class="input-append-left" type="text" id="node-config-input-port" placeholder="9445">
  </div>
  <div class="form-row">
    <label for="node-config-input-username"><i class="fa fa-user"></i> Username</label>
    <input type="text" id="node-config-input-username">
  </div>
  <div class="form-row">
    <label for="node-config-input-pass"><i class="fa fa-lock"></i> Password</label>
    <input type="password" id="node-config-input-pass">
  </div>
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Name">
  </div>
</script>

<script type="text/javascript">
  RED.nodes.registerType("ibm-igc",{
    category: "config",
    color: "rgb(114, 199, 231)",
    defaults: {
      host: { value: "", required: true },
      port: { value: "9445", required: true },
      name: { value: "" }
    },
    credentials: {
      username: { type: "text" },
      pass: { type: "password" }
    },
    label: function() {
      return this.name || this.host;
    }
  });
</script>

<script type="text/x-red" data-template-name="IGC search">
  <div class="form-row" id="node-input-external-details">
    <label for="node-input-server"><i class="fa fa-bookmark"></i> Server</label>
    <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
    <label for="node-input-query"><i class="fa fa-search"></i> Query</label>
    <input type="text" id="node-input-query" placeholder="{}" style="width:65%;">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" style="width:65%;">
  </div>
</script>

<script type="text/x-red" data-template-name="IGC get">
  <div class="form-row" id="node-input-external-details">
    <label for="node-input-server"><i class="fa fa-bookmark"></i> Server</label>
    <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
    <label for="node-input-url"><i class="fa fa-reply"></i> URL</label>
    <input type="text" id="node-input-url" style="width:65%;">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" style="width:65%;">
  </div>
</script>

<script type="text/x-red" data-template-name="IGC update">
  <div class="form-row" id="node-input-external-details">
    <label for="node-input-server"><i class="fa fa-bookmark"></i> Server</label>
    <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
    <label for="node-input-rid"><i class="fa fa-barcode"></i> RID</label>
    <input type="text" id="node-input-rid" style="width:65%;">
  </div>
  <div class="form-row">
    <label for="node-input-update"><i class="fa fa-save"></i> Update</label>
    <input type="text" id="node-input-update" style="width:65%;">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" style="width:65%;">
  </div>
</script>

<script type="text/javascript">
  RED.nodes.registerType("IGC search", {
    category: "storage-input",
    color: "rgb(114, 199, 231)",
    defaults: {
      name: { value: "" },
      server: { type:"ibm-igc", required: true },
      query: { value: "" }
    },
    inputs: 1,
    outputs: 1,
    icon: "ibm-igc.png",
    align: "left",
    label: label,
    labelStyle: function() {
      return this.name ? "node_label_italic" : "";
    }
  });

  RED.nodes.registerType("IGC get", {
    category: "storage-input",
    color: "rgb(114, 199, 231)",
    defaults: {
      name: { value: "" },
      server: { type:"ibm-igc", required: true },
      url: { value: "" }
    },
    inputs: 1,
    outputs: 1,
    icon: "ibm-igc.png",
    align: "left",
    label: label,
    labelStyle: function() {
      return this.name ? "node_label_italic" : "";
    }
  });

  RED.nodes.registerType("IGC update", {
    category: "storage-output",
    color: "rgb(114, 199, 231)",
    defaults: {
      name: { value: "" },
      server: { type:"ibm-igc", required: true },
      rid: { value: "" },
      update: { value: "" }
    },
    inputs: 1,
    outputs: 0,
    icon: "ibm-igc.png",
    align: "right",
    label: label,
    labelStyle: function() {
      return this.name ? "node_label_italic" : "";
    }
  });

  function label() {
    return this.name || this.host || "IGC";
  }
</script>

<script type="text/x-red" data-help-name="IGC search">
  <p>
    A node for searching metadata in Information Governance Catalog.
  </p>
  <p>
    This uses the POST-based Information Governance Catalog REST API to run
    an arbitrary search, based on the parameters provided in the <code>msg.payload</code>.
  </p>
  <p>
    For example, you can pass a query like this (<code>msg.payload</code>'s entire contents as follows):
  </p>
  <p>
    <code>
    {
      "properties": ["name"],
      "types": ["term"],
      "where":
      {
        "operator": "and",
        "conditions": [
          {
            "property": "modified_on",
            "operator": ">=",
            "value": "1483232400"
          }
        ]
      }
    }
    </code>
  </p>
  <p>
    to get a listing of the names of all business terms that were modified on
    or after January 1, 2017 (value provided as UNIX time).  You can find more 
    information about queries and examples in the <a
    href="http://www.ibm.com/support/docview.wss?uid=swg27047054&aid=1" target="_blank">
    Tips, Tricks &amp; Time-Savers Guide</a> and the <a 
    href="http://www.ibm.com/support/docview.wss?uid=swg27047059&aid=1" target="_blank">
    Sample Rest API Calls and Use Case Descriptions Guide</a>.
  </p>
</script>

<script type="text/x-red" data-help-name="IGC get">
  <p>
    A node for retrieving metadata from Information Governance Catalog.
  </p>
  <p>
    This uses any arbitrary GET-based Information Governance Catalog REST API URL to
    retrieve information from IGC.  The parameter containing the URL is expected to 
    be <code>msg.url</code>
  </p>
  <p>
    For example, you can pass any URL returned by a previous query's <code>next</code> property
    (for pagination), or the <code>_url</code> property (to get more details on that particular
    asset).
  </p>
  <p>
    (Note: the specific host details supplied in the URL will be overridden by the Server
    selected via configuration -- necessary to ensure credentials are passed appropriately).
  </p>
</script>

<script type="text/x-red" data-help-name="IGC update">
  <p>
    A node for updating metadata in Information Governance Catalog.
  </p>
  <p>
    This expects a unique IGC identifier ("RID") to specify which specific piece of metadata
    to update; provided as <code>msg.rid</code>.  An additional parameter, <code>msg.update</code>,
    is also needed to define what on that piece of metadata should be updated.  This second 
    parameter is expected to be a JSON object.
  </p>
  <p>
    For example, you can use the following <code>msg.update</code>:
  </p>
  <p>
    <code>
    {
      "short_description": "a new short description",
      "labels": {
        "items": [ "6662c0f2.22257cc4.p864keo17.vbbgrpe.26j4m1.mgcmn0lh4fb2ggdjb7ujo", "6662c0f2.22257cc4.p864keo18.0o97qi8.f1ar57.dmjlsjtjghbifmi6p2tc4" ],
        "mode": "add"
      }
    }
    </code>
  </p>
  <p>
    to update the short description of the piece of metadata, and also add (append) two new labels.  
    Note that related items must also be specified by their RID; the other mode that is likely of
    use is <code>replace</code>, which will overwrite any existing relationships (and if you provide
    an empty array, will remove all existing relationships).
  </p>
</script>
